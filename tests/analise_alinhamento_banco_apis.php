<?php
/**
 * üîç AN√ÅLISE DE ALINHAMENTO: BANCO DE DADOS vs APIs
 * 
 * Verifica se as APIs est√£o alinhadas com a estrutura do banco normalizado
 */

echo "üîç AN√ÅLISE DE ALINHAMENTO: BANCO DE DADOS vs APIs\n";
echo "=================================================\n\n";

// ==========================================================================
// ESTRUTURA DO BANCO NORMALIZADO
// ==========================================================================

$tabelas_banco = [
    'usuarios' => [
        'campos' => ['id', 'nome', 'cpf', 'email', 'senha', 'status', 'data_criacao', 'data_ultimo_acesso'],
        'api_pasta' => 'src/api/usuarios/',
        'status' => '‚úÖ Alinhada'
    ],
    'unidades' => [
        'campos' => ['id', 'nome', 'telefone', 'endereco', 'codigo_acesso', 'status', 'data_criacao'],
        'api_pasta' => 'src/api/unidades/',
        'status' => '‚úÖ Alinhada'
    ],
    'funcionarios' => [
        'campos' => ['id', 'usuario_id', 'unidade_id', 'cargo', 'status', 'data_vinculo', 'data_aprovacao', 'data_demissao'],
        'api_pasta' => 'src/api/funcionarios/',
        'status' => '‚úÖ Alinhada'
    ],
    'aprovacoes_acesso' => [
        'campos' => ['id', 'funcionario_id', 'tipo', 'status', 'data_solicitacao', 'data_decisao', 'gestor_id', 'observacoes'],
        'api_pasta' => 'src/api/aprovacoes_acesso/',
        'status' => '‚úÖ Alinhada'
    ],
    'aprovacoes' => [
        'campos' => ['id', 'tipo', 'referencia_id', 'funcionario_id', 'status', 'data_solicitacao', 'data_decisao', 'gestor_id', 'observacoes'],
        'api_pasta' => 'src/api/aprovacoes/',
        'status' => '‚úÖ Alinhada'
    ],
    'jogadores' => [
        'campos' => ['id', 'unidade_id', 'nome', 'cpf', 'telefone', 'email', 'status', 'data_cadastro', 'limite_credito', 'saldo_atual', 'funcionario_cadastro_id'],
        'api_pasta' => 'src/api/jogadores/',
        'status' => '‚ö†Ô∏è Parcialmente alinhada'
    ],
    'caixas' => [
        'campos' => ['id', 'unidade_id', 'funcionario_abertura_id', 'funcionario_fechamento_id', 'status', 'data_abertura', 'data_fechamento', 'inventario_inicial', 'inventario_final', 'observacoes'],
        'api_pasta' => 'src/api/caixas/',
        'status' => '‚ö†Ô∏è Parcialmente alinhada'
    ],
    'fichas_denom' => [
        'campos' => ['id', 'unidade_id', 'valor', 'descricao', 'status'],
        'api_pasta' => 'src/api/fichas_denom/',
        'status' => '‚ùå Pasta vazia'
    ],
    'inventario_fichas' => [
        'campos' => ['id', 'caixa_id', 'ficha_denom_id', 'quantidade_inicial', 'quantidade_final'],
        'api_pasta' => 'src/api/inventario_fichas/',
        'status' => '‚ùå Pasta vazia'
    ],
    'movimentacoes_fichas' => [
        'campos' => ['id', 'caixa_id', 'jogador_id', 'funcionario_id', 'tipo', 'ficha_denom_id', 'quantidade', 'valor_total', 'data', 'observacoes'],
        'api_pasta' => 'src/api/movimentacoes_fichas/',
        'status' => '‚ö†Ô∏è Parcialmente alinhada'
    ],
    'caixinhas' => [
        'campos' => ['id', 'caixa_id', 'funcionario_criacao_id', 'nome', 'valor_meta', 'valor_atual', 'status', 'data_criacao', 'data_conclusao', 'observacoes'],
        'api_pasta' => 'src/api/caixinhas/',
        'status' => '‚úÖ Alinhada'
    ],
    'caixinhas_inclusoes' => [
        'campos' => ['id', 'caixinha_id', 'funcionario_id', 'valor', 'data_inclusao', 'observacoes'],
        'api_pasta' => 'src/api/caixinhas_inclusoes/',
        'status' => '‚úÖ Alinhada'
    ],
    'gastos' => [
        'campos' => ['id', 'caixa_id', 'funcionario_id', 'categoria', 'descricao', 'valor', 'observacoes', 'data_registro', 'status'],
        'api_pasta' => 'src/api/gastos/',
        'status' => '‚úÖ Alinhada'
    ],
    'rake' => [
        'campos' => ['id', 'caixa_id', 'funcionario_id', 'valor', 'data_hora', 'observacoes'],
        'api_pasta' => 'src/api/rake/',
        'status' => '‚úÖ Alinhada'
    ],
    'relatorios_historico' => [
        'campos' => ['id', 'funcionario_id', 'unidade_id', 'tipo', 'status', 'data_geracao', 'data_conclusao', 'arquivo', 'mensagem_erro', 'parametros'],
        'api_pasta' => 'src/api/relatorios_historico/',
        'status' => '‚ùå Pasta vazia'
    ],
    'transacoes_jogadores' => [
        'campos' => ['id', 'jogador_id', 'caixa_id', 'funcionario_id', 'tipo', 'valor', 'observacao', 'data_transacao', 'quitado', 'data_quitacao'],
        'api_pasta' => 'src/api/transacoes_jogadores/',
        'status' => '‚úÖ Alinhada'
    ]
];

// ==========================================================================
// AN√ÅLISE DE ALINHAMENTO
// ==========================================================================

echo "üìä AN√ÅLISE DE ALINHAMENTO POR TABELA\n";
echo "====================================\n\n";

$total_tabelas = count($tabelas_banco);
$tabelas_alinhadas = 0;
$tabelas_parciais = 0;
$tabelas_nao_alinhadas = 0;

foreach ($tabelas_banco as $tabela => $info) {
    echo "üìã $tabela\n";
    echo "   Status: {$info['status']}\n";
    echo "   Pasta API: {$info['api_pasta']}\n";
    echo "   Campos: " . implode(', ', $info['campos']) . "\n";
    
    // Verificar se a pasta existe
    if (is_dir($info['api_pasta'])) {
        $arquivos = scandir($info['api_pasta']);
        $arquivos = array_diff($arquivos, ['.', '..']);
        echo "   APIs encontradas: " . count($arquivos) . "\n";
        
        if (count($arquivos) > 0) {
            if ($info['status'] === '‚úÖ Alinhada') {
                $tabelas_alinhadas++;
            } elseif ($info['status'] === '‚ö†Ô∏è Parcialmente alinhada') {
                $tabelas_parciais++;
            }
        } else {
            $tabelas_nao_alinhadas++;
        }
    } else {
        echo "   ‚ùå Pasta n√£o existe\n";
        $tabelas_nao_alinhadas++;
    }
    echo "\n";
}

// ==========================================================================
// PROBLEMAS IDENTIFICADOS
// ==========================================================================

echo "üö® PROBLEMAS IDENTIFICADOS\n";
echo "==========================\n\n";

$problemas = [
    'jogadores' => [
        'problema' => 'API usa campos antigos (created_by) em vez de funcionario_cadastro_id',
        'solucao' => 'Atualizar API para usar funcionario_cadastro_id'
    ],
    'caixas' => [
        'problema' => 'API usa campos antigos (nome, created_by) em vez da estrutura normalizada',
        'solucao' => 'Atualizar API para usar unidade_id, funcionario_abertura_id, inventario_inicial'
    ],
    'fichas_denom' => [
        'problema' => 'Pasta vazia - APIs n√£o implementadas',
        'solucao' => 'Implementar APIs CRUD para denomina√ß√µes de fichas'
    ],
    'inventario_fichas' => [
        'problema' => 'Pasta vazia - APIs n√£o implementadas',
        'solucao' => 'Implementar APIs para controle de invent√°rio'
    ],
    'movimentacoes_fichas' => [
        'problema' => 'API parcial - precisa trabalhar com fichas_denom',
        'solucao' => 'Atualizar API para usar ficha_denom_id'
    ],
    'relatorios_historico' => [
        'problema' => 'Pasta vazia - APIs n√£o implementadas',
        'solucao' => 'Implementar APIs para hist√≥rico de relat√≥rios'
    ]
];

foreach ($problemas as $tabela => $info) {
    echo "‚ö†Ô∏è  $tabela\n";
    echo "   Problema: {$info['problema']}\n";
    echo "   Solu√ß√£o: {$info['solucao']}\n\n";
}

// ==========================================================================
// APIS QUE PRECISAM ATUALIZA√á√ÉO
// ==========================================================================

echo "üîÑ APIS QUE PRECISAM ATUALIZA√á√ÉO\n";
echo "===============================\n\n";

$apis_para_atualizar = [
    'api/jogadores/criar.php' => 'Usar funcionario_cadastro_id em vez de created_by',
    'api/jogadores/atualizar.php' => 'Usar funcionario_cadastro_id em vez de created_by',
    'api/caixas/criar.php' => 'Usar estrutura normalizada (unidade_id, funcionario_abertura_id, inventario_inicial)',
    'api/caixas/atualizar.php' => 'Usar estrutura normalizada',
    'api/movimentacoes_fichas/movimentar.php' => 'Usar ficha_denom_id em vez de valor direto'
];

foreach ($apis_para_atualizar as $api => $motivo) {
    echo "üîÑ $api\n";
    echo "   Motivo: $motivo\n\n";
}

// ==========================================================================
// RESUMO ESTAT√çSTICO
// ==========================================================================

echo "üìä RESUMO ESTAT√çSTICO\n";
echo "=====================\n\n";

echo "üìã ALINHAMENTO:\n";
echo "   ‚Ä¢ Tabelas alinhadas: $tabelas_alinhadas/$total_tabelas\n";
echo "   ‚Ä¢ Tabelas parcialmente alinhadas: $tabelas_parciais/$total_tabelas\n";
echo "   ‚Ä¢ Tabelas n√£o alinhadas: $tabelas_nao_alinhadas/$total_tabelas\n\n";

$percentual_alinhamento = round((($tabelas_alinhadas + $tabelas_parciais) / $total_tabelas) * 100, 1);

echo "üìà PERCENTUAL DE ALINHAMENTO: $percentual_alinhamento%\n\n";

// ==========================================================================
// RECOMENDA√á√ïES
// ==========================================================================

echo "üéØ RECOMENDA√á√ïES\n";
echo "================\n\n";

echo "1. üîÑ ATUALIZAR APIS EXISTENTES:\n";
echo "   ‚Ä¢ Corrigir APIs de jogadores para usar funcionario_cadastro_id\n";
echo "   ‚Ä¢ Corrigir APIs de caixas para usar estrutura normalizada\n";
echo "   ‚Ä¢ Atualizar movimentacoes_fichas para usar ficha_denom_id\n\n";

echo "2. ‚ûï IMPLEMENTAR APIS FALTANTES:\n";
echo "   ‚Ä¢ Criar APIs para fichas_denom\n";
echo "   ‚Ä¢ Criar APIs para inventario_fichas\n";
echo "   ‚Ä¢ Criar APIs para relatorios_historico\n\n";

echo "3. ‚úÖ PRIORIDADES:\n";
echo "   ‚Ä¢ Alta: Corrigir APIs de jogadores e caixas\n";
echo "   ‚Ä¢ M√©dia: Implementar APIs de fichas_denom\n";
echo "   ‚Ä¢ Baixa: Implementar APIs de inventario e hist√≥rico\n\n";

echo "4. üß™ TESTES:\n";
echo "   ‚Ä¢ Testar todas as APIs ap√≥s corre√ß√µes\n";
echo "   ‚Ä¢ Validar integridade dos dados\n";
echo "   ‚Ä¢ Verificar funcionalidades do frontend\n\n";

// ==========================================================================
// STATUS FINAL
// ==========================================================================

echo "üéØ STATUS FINAL\n";
echo "===============\n\n";

if ($percentual_alinhamento >= 90) {
    echo "‚úÖ EXCELENTE ALINHAMENTO\n";
    echo "   O sistema est√° bem alinhado com o banco normalizado!\n";
} elseif ($percentual_alinhamento >= 70) {
    echo "‚ö†Ô∏è  BOM ALINHAMENTO\n";
    echo "   Algumas corre√ß√µes s√£o necess√°rias, mas o sistema funciona.\n";
} else {
    echo "‚ùå ALINHAMENTO INSUFICIENTE\n";
    echo "   Corre√ß√µes significativas s√£o necess√°rias.\n";
}

echo "\n=================================================\n";
echo "‚úÖ AN√ÅLISE CONCLU√çDA\n";
echo "=================================================\n";
?> 